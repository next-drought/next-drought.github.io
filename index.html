<!DOCTYPE html>
<html>

<a title="GDPR-compliant Web Analytics" href="https://clicky.com/101398452"><img alt="Clicky"
        src="//static.getclicky.com/media/links/badge.gif" /></a>
<script async src="//static.getclicky.com/101398452.js"></script>
<noscript>
    <p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101398452ns.gif" /></p>
</noscript>

<head>
    <meta charset="UTF-8">
    <title>Temperature and Fire Risk Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"
        integrity="sha512-c4v4uz4x4e1kXZ+pYnY1vJtlyjKwP2b/2HJdNvJJtba5iuNp5kj5Z8cWYzgSd3w3qzKoH8E4W+0vQeLx0/LRQ=="
        crossorigin="" />
    <style>
        #map {
            position: relative;
            width: 100%;
            height: 800px;
        }

        .my-custom-control {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }

        .my-custom-control img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script>
        $(document).ready(function () {

            var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            });

            var map = L.map('map', {
                center: [30.6333, -97.6837],
                zoom: 10,
                layers: [osm]
            });


            // Location marker
            var locationOverlay = L.layerGroup();

            navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                var marker = L.marker([lat, lng]).addTo(locationOverlay);
            });

            var overlayMaps = {
                "My Location": locationOverlay
            };


            // Geotiff

            var url_to_geotiff_file = "https://s3.us-east-2.amazonaws.com/thedynamicpacific.com/fuel.tif";

            fetch(url_to_geotiff_file)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    parseGeoraster(arrayBuffer).then(georaster => {
                        const min = georaster.mins[0];
                        const max = georaster.maxs[0];
                        const range = georaster.ranges[0];

                        // available color scales can be found by running console.log(chroma.brewer);
                        console.log(chroma.brewer);
                        var scale = chroma.scale("Viridis");

                        var layer = new GeoRasterLayer({
                            georaster: georaster,
                            opacity: 0.7,
                            pixelValuesToColorFn: function (pixelValues) {
                                var pixelValue = pixelValues[
                                    0]; // there's just one band in this raster

                                // if there's zero wind, don't return a color
                                if (pixelValue === 0) return null;

                                // scale to 0 - 1 used by chroma
                                var scaledPixelValue = (pixelValue - min) / range;

                                var color = scale(scaledPixelValue).hex();

                                return color;
                            },
                            resolution: 256
                        });
                        console.log("layer:", layer);
                        layer.addTo(map);
                        layerControl.addOverlay(layer, "Fuelmap");
                        // map.fitBounds(layer.getBounds());
                    });
                });

            var baseMaps = {
                "OpenStreetMap": osm
            };

            var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

            var satellite = L.tileLayer("https://mt1.google.com/vt/lyrs=y\u0026x={x}\u0026y={y}\u0026z={z}", {
                "attribution": "Google",
                "detectRetina": false,
                "maxNativeZoom": 22,
                "maxZoom": 22,
                "minZoom": 0,
                "noWrap": false,
                "opacity": 1,
                "subdomains": "abc",
                "tms": false
            });
            layerControl.addBaseLayer(satellite, "Satellite");
            // Legend div current issue: associate fuelmap and legend.

            // Create a custom control with a div element and an image
            var MyControl = L.Control.extend({
                options: {
                    position: 'bottomright'
                },

                onAdd: function (map) {
                    var container = L.DomUtil.create('div', 'my-custom-control my-custom-control-small');

                    // Create a new div element for the scrollable container
                    var scrollableDiv = document.createElement('div');
                    scrollableDiv.style.height = '400px';
                    scrollableDiv.style.overflowY = 'auto';
                    scrollableDiv.style.display = 'none';

                    // Create a new image element for the legend
                    var legendImg = document.createElement('img');
                    legendImg.src = './legend.png';
                    legendImg.alt = 'Legend';
                    legendImg.style.maxWidth = '100%';
                    legendImg.style.height = 'auto';

                    // Append the legend image to the scrollable container
                    scrollableDiv.appendChild(legendImg);

                    // Append the scrollable container to the container element
                    container.appendChild(scrollableDiv);

                    // Create a new image element for the control icon
                    var iconImg = document.createElement('img');
                    iconImg.src = 'Control_Icon.jpg';
                    iconImg.alt = 'Legend_Icon.png';
                    iconImg.style.width = '50px';
                    iconImg.style.height = '50px';

                    // Append the icon image to the container element
                    container.appendChild(iconImg);

                    // Add an event listener to show the legend image when the control is hovered over
                    container.addEventListener('mouseover', function () {
                        scrollableDiv.style.display = 'block';
                        container.classList.remove('my-custom-control-small');
                        iconImg.style.display = 'none';
                    });

                    // Add an event listener to hide the legend image when the control is no longer hovered over
                    container.addEventListener('mouseout', function () {
                        scrollableDiv.style.display = 'none';
                        container.classList.add('my-custom-control-small');
                        iconImg.style.display = 'block';
                    });

                    // Show the control when the "layer" overlay is added to the map
                    map.on('overlayadd', function (e) {
                        if (e.name == 'Fuelmap') {
                            container.style.display = 'block';
                        }
                    });

                    // Hide the control when the "layer" overlay is removed from the map
                    map.on('overlayremove', function (e) {
                        if (e.name === 'Fuelmap') {
                            container.style.display = 'none';
                        }
                    });

                    return container;
                }
            });

            // Create an instance of the custom control and add it to the map
            var myControl = new MyControl();
            myControl.addTo(map);



        });
    </script>
</body>

</html>
